# リファクタリング計画書: ターン処理システムの再設計

## 1. 背景

これまで、敵AIの移動に関するバグ（交通渋滞、不自然な移動、ユニットの消失、衝突、操作不能など）に対して、繰り返し修正を行ってきた。しかし、一つの問題を修正すると別の問題が露呈する状況が続いており、根本的な原因が個々のバグではなく、ターン処理全体のアーキテクチャの複雑さと責務分担の曖昧さにあることが明らかになった。

本計画書は、場当たり的な修正を中止し、ターン処理システムをより堅牢で予測可能なものに再設計することを目的とする。

## 2. 設計目標

- **明確な責任分担:** 各コンポーネント（`EnemyThinker`, `GameTurnManager`, `ConflictResolverSubsystem`）が単一の明確な責務を持つようにする。
- **堅牢性:** ユニットのアクションが消失したり、システムがデッドロックに陥ったりすることなく、あらゆる状況を安全に処理できるようにする。サイレントな失敗を許容しない。
- **予測可能性とデバッグの容易さ:** ターンの結果が決定論的であり、問題が発生した際に原因の特定が容易な構造にする。

## 3. 新しいターン処理ライフサイクル

現在の複雑な処理フローを廃止し、以下の4つの明確なフェーズに分割されたライフサイクルを導入する。

### フェーズ1：インテント（行動意思）の表明 (Intent Declaration)

- **役割:** 各ユニット（AI、プレイヤー）が、そのターンで何をしたいかを決定する。
- **処理内容:**
    - 各`EnemyThinker`は、`DistanceField`に基づき、検証を行わずに最も理想的な行動（`MOVE`または`ATTACK`）を`AICommand`として生成する。
    - プレイヤーは、入力に基づき`PlayerCommand`を生成する。
- **責務:** AIは「意思決定」のみに集中し、「移動可能か」などの検証は一切行わない。

### フェーズ2：インテントの収集とモード決定 (Intent Collection & Mode Determination)

- **役割:** すべてのユニットの意思を集約し、ターンの全体像を把握する。
- **処理内容:**
    - `GameTurnManager`が、すべての`AICommand`と`PlayerCommand`を単一のリストに収集する。
    - 収集したリスト内に`ATTACK`コマンドが1つでも含まれているかを確認し、そのターンのモードを`Sequential`（逐次）か`Simultaneous`（同時）かに確定する。
- **責務:** `GameTurnManager`がインテントを収集し、ターン全体のモードを決定する。

### フェーズ3：競合解決 (Conflict Resolution)

- **役割:** 全ユニットのインテント間の衝突を解決し、実行可能な最終アクションを決定する。
- **処理内容:**
    - `ConflictResolverSubsystem`が、インテントのリストと確定した`TurnMode`を受け取る。
    - **解決ルール:**
        - **`Sequential`モードの場合:**
            1. `ATTACK`インテントを持つユニットの現在地を「移動不可」としてロックする。
            2. `MOVE`インテントを、ロックされたマスや他の`MOVE`インテントと衝突しないように解決する。衝突した`MOVE`は`WAIT`（待機）に変更する。
        - **`Simultaneous`モードの場合:**
            1. 全ての`MOVE`インテントの目的地が衝突しないように解決する。目的地が重複した場合は、片方を`WAIT`に変更する。
    - **重要な契約:** このフェーズは、受け取ったインテントを**絶対に消失させない**。すべてのアクションは、必ず`MOVE`, `ATTACK`, `WAIT`のいずれかの**解決済みアクション**に変換され、インテントと同じ数のアクションが返される。
- **責務:** `ConflictResolverSubsystem`が交通整理を行い、矛盾のないアクションリストを作成する。

### フェーズ4：解決済みアクションの実行 (Resolved Action Execution)

- **役割:** 解決済みのクリーンなアクションリストを順番に実行する。
- **処理内容:**
    - `GameTurnManager`が、解決済みアクションのリストを受け取る。
    - `TurnMode`に応じてアクションをディスパッチ（実行）する。
        - **`Sequential`モードの場合:** まず`ATTACK`アクションをすべて実行し、完了を待ってから`MOVE`/`WAIT`アクションをすべて実行する。
        - **`Simultaneous`モードの場合:** すべての`MOVE`/`WAIT`アクションを同時に実行する。
- **責務:** `GameTurnManager`が、解決済みの計画に沿ってアクションを実行する。

## 5. 実装ステップ

この再設計を、以下の段階的なステップで進める。

1.  **`GameTurnManager`の改修（フェーズ2の実装）:**
    - ターンモード（`Sequential`/`Simultaneous`）の決定ロジックを、すべてのインテントを収集した後に一括で行うように中央集権化する。
2.  **`ConflictResolverSubsystem`の改修（フェーズ3の実装）:**
    - 新しい解決ルール（攻撃者のマスをブロック、全インテントを必ず解決）を実装する。アクションを消失させないことを保証する。
3.  **`EnemyThinker`の簡素化（フェーズ1の実装）:**
    - 再度、AIからすべての事前検証ロジックを削除し、純粋なインテントの表明に専念させる。
4.  **`GameTurnManager`の改修（フェーズ4の実装）:**
    - 新しいライフサイクルに基づき、アクションの実行ロジックを`Sequential`と`Simultaneous`で明確に分離・整理する。
5.  **`PlayerInputProcessor`の`WindowId`問題の修正:**
    - `GameTurnManager`のターン状態管理の一環として、`WindowId`がターンごとに確実にインクリメントされる機構を組み込む。
